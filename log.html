<!DOCTYPE html>
<html>
<head>
  <title>Dictionary Change Monitor</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #loading { padding: 20px; text-align: center; }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    .pagination {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .pagination button {
      padding: 5px 10px;
      cursor: pointer;
      background: #1976D2;
      color: white;
      border: none;
      border-radius: 4px;
    }
    .pagination button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .page-info {
      font-weight: bold;
    }
    .log-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 70vh;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 4px;
      background: #fafafa;
    }
    .log-entry { border-left: 4px solid #ddd; padding: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 0 4px 4px 0; }
    .log-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; }
    .log-path { font-weight: bold; color: #1976D2; }
    .log-time { color: #666; font-size: 0.8em; }
    .log-diff { margin-top: 8px; padding-left: 12px; }
    .diff-item { margin: 4px 0; padding: 4px; border-radius: 3px; }
    .added { background-color: #E8F5E9; border-left: 3px solid #4CAF50; }
    .removed { background-color: #FFEBEE; border-left: 3px solid #F44336; text-decoration: line-through; }
    .changed { background-color: #FFF3E0; border-left: 3px solid #FF9800; }
    .key { font-weight: bold; color: #333; }
    .value { margin-left: 4px; }
    .filter-controls input {
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-width: 300px;
    }
  </style>
</head>
<body>
  <h1>Dictionary Change Monitor</h1>
  <div id="loading">Loading...</div>
  
  <div class="controls">
    <div class="filter-controls">
      <input type="text" id="path-filter" placeholder="Filter by path...">
    </div>
    <div class="pagination">
      <button id="prev-page" disabled>Previous</button>
      <span class="page-info">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
      <button id="next-page" disabled>Next</button>
    </div>
  </div>
  
  <div id="log-container" class="log-container"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3D_wCMyR65nTT_WHpPjn4HvEsLA6RANc",
      authDomain: "dict-multilingual.firebaseapp.com",
      databaseURL: "https://dict-multilingual-default-rtdb.firebaseio.com",
      projectId: "dict-multilingual",
      storageBucket: "dict-multilingual.appspot.com",
      messagingSenderId: "330095453001",
      appId: "1:330095453001:web:4166435a9d2653cc23f098"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const logContainer = document.getElementById('log-container');
    let isLoading = true;
    let previousData = {};
    const itemsPerPage = 20;
    let currentPage = 1;
    let totalPages = 1;
    let allLogEntries = [];
    let filteredLogEntries = [];
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const currentPageSpan = document.getElementById('current-page');
    const totalPagesSpan = document.getElementById('total-pages');
    const pathFilterInput = document.getElementById('path-filter');

    function createLogEntry(path, timestamp) {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const timeString = new Date(timestamp).toLocaleString();
      entry.innerHTML = `
        <div class="log-header">
          <span class="log-path">${path.replace('dictionary/', '')}</span>
          <span class="log-time">${timeString}</span>
        </div>
        <div class="log-diff"></div>
      `;
      return {
        element: entry,
        diffContainer: entry.querySelector('.log-diff'),
        path: path,
        timestamp: timestamp
      };
    }

    function formatValue(value) {
      if (value === null) return 'null';
      if (value === undefined) return 'undefined';
      if (typeof value === 'object') return JSON.stringify(value, null, 2);
      return value.toString();
    }

    function getObjectDiff(oldObj = {}, newObj = {}) {
      const diff = {};
      const allKeys = new Set([...Object.keys(oldObj || {}), ...Object.keys(newObj || {})]);
      allKeys.forEach(key => {
        if (!(key in newObj)) {
          diff[key] = { type: 'removed', value: oldObj[key] };
        } else if (!(key in oldObj)) {
          diff[key] = { type: 'added', value: newObj[key] };
        } else if (JSON.stringify(oldObj[key]) !== JSON.stringify(newObj[key])) {
          if (typeof oldObj[key] === 'object' && typeof newObj[key] === 'object' && oldObj[key] !== null && newObj[key] !== null) {
            diff[key] = { type: 'changed', diff: getObjectDiff(oldObj[key], newObj[key]) };
          } else {
            diff[key] = { type: 'changed', old: oldObj[key], new: newObj[key] };
          }
        }
      });
      return diff;
    }

    function renderObjectDiff(container, diff, level = 0) {
      Object.entries(diff).forEach(([key, change]) => {
        const item = document.createElement('div');
        item.className = `diff-item ${change.type}`;
        item.style.marginLeft = `${level * 12}px`;
        if (change.type === 'added' || change.type === 'removed') {
          item.innerHTML = `<span class="key">${key}:</span> <span class="value">${formatValue(change.value)}</span>`;
          container.appendChild(item);
        } else if (change.type === 'changed') {
          if (change.diff) {
            const nestedContainer = document.createElement('div');
            nestedContainer.className = 'nested';
            renderObjectDiff(nestedContainer, change.diff, level + 1);
            item.innerHTML = `<span class="key">${key}:</span>`;
            container.appendChild(item);
            container.appendChild(nestedContainer);
          } else {
            item.innerHTML = `<span class="key">${key}:</span>
              <span class="value"><span style="color:#F44336">${formatValue(change.old)}</span> â†’ 
              <span style="color:#4CAF50">${formatValue(change.new)}</span></span>`;
            container.appendChild(item);
          }
        }
      });
    }

    function updatePaginationControls() {
      currentPageSpan.textContent = currentPage;
      totalPagesSpan.textContent = totalPages;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
    }

    function renderCurrentPage() {
      logContainer.innerHTML = '';
      const startIdx = (currentPage - 1) * itemsPerPage;
      const endIdx = startIdx + itemsPerPage;
      const entriesToShow = filteredLogEntries.slice(startIdx, endIdx);
      if (entriesToShow.length === 0) {
        logContainer.innerHTML = '<div class="log-entry">No changes match the current filters</div>';
        return;
      }
      entriesToShow.forEach(entry => {
        logContainer.appendChild(entry.element);
      });
      updatePaginationControls();
    }

    function applyFilters() {
      const pathFilter = pathFilterInput.value.toLowerCase();
      filteredLogEntries = allLogEntries.filter(entry => {
        return pathFilter ? entry.path.toLowerCase().includes(pathFilter) : true;
      });
      totalPages = Math.max(1, Math.ceil(filteredLogEntries.length / itemsPerPage));
      currentPage = 1;
      renderCurrentPage();
    }

    function handleChange(path, oldData, newData) {
      const timestamp = Date.now();
      const logEntry = createLogEntry(path, timestamp);
      const diff = getObjectDiff(oldData, newData);
      renderObjectDiff(logEntry.diffContainer, diff);
      allLogEntries.unshift(logEntry);
      applyFilters();
      if (isLoading) {
        document.getElementById('loading').style.display = 'none';
        isLoading = false;
      }
    }

    function setupDeepListeners(ref, path = 'dictionary') {
      if (path !== 'dictionary') {
        ref.on('value', snapshot => {
          const newData = snapshot.val();
          const oldData = previousData[path] || {};
          if (JSON.stringify(oldData) !== JSON.stringify(newData)) {
            handleChange(path, oldData, newData);
            previousData[path] = JSON.parse(JSON.stringify(newData || {}));
          }
        });
      }
      ref.on('child_added', childSnapshot => {
        const childPath = `${path}/${childSnapshot.key}`;
        setupDeepListeners(ref.child(childSnapshot.key), childPath);
      });
    }

    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderCurrentPage();
      }
    });

    nextPageBtn.addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderCurrentPage();
      }
    });

    pathFilterInput.addEventListener('input', applyFilters);

    db.ref('dictionary').once('value', snapshot => {
      previousData.dictionary = snapshot.val() || {};
      document.getElementById('loading').style.display = 'none';
      isLoading = false;
    });

    setupDeepListeners(db.ref('dictionary'));
  </script>
</body>
</html>